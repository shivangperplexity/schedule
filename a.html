<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin - दौरा कार्यक्रम</title>
<style>
body { font-family:"Noto Sans Devanagari",sans-serif; background:#f7f7f7; margin:0; padding:0; }
header { background:#e65100; color:white; padding:15px; text-align:center; font-size:20px; font-weight:bold; }
.container { max-width:600px; margin:30px auto; padding:15px; background:white; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
h2 { text-align:center; color:#e65100; margin-bottom:20px; }
input, button, textarea, select { width:100%; margin:8px 0; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
button { background:#e65100; color:white; border:none; cursor:pointer; font-weight:bold; }
button:hover { background:#bf360c; }
.hidden { display:none; }
.event-list { margin-top:20px; }
.event-item, .gallery-item-admin { background:#f1f1f1; padding:10px; border-radius:8px; margin-bottom:10px; display: flex; justify-content: space-between; align-items: center; }
.event-item .actions button, .gallery-item-admin .actions button { width: auto; padding: 5px 10px; font-size: 14px; margin-left: 5px; }
#gallery-upload { text-align: center; margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 8px; border: 1px dashed #e65100; }
#gallery-upload input[type="file"] { border: none; }
.gallery-admin-list { margin-top: 20px; }
.gallery-admin-list img { width: 60px; height: 60px; object-fit: cover; margin-right: 10px; }
</style>
<script type="module">
// Firebase for Schedule
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Supabase for Gallery
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Firebase Configuration (Schedule)
const firebaseConfig = {
  apiKey: "AIzaSyD7dNWujSZFUSat3zKH0lXf8hNZKCv6-XU",
  authDomain: "schedule-balasaheb.firebaseapp.com",
  projectId: "schedule-balasaheb",
  storageBucket: "schedule-balasaheb.appspot.com",
  messagingSenderId: "614219892733",
  appId: "1:614219892733:web:15f60c89267014cab37b94"
};
const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);

// Supabase Configuration (Gallery)
const SUPABASE_URL = "https://ckmysozgdvemawcffpjr.supabase.co"; 
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrbXlzb3pnZHZlbWF3Y2ZmcGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzQ5NzIsImV4cCI6MjA3MzU1MDk3Mn0.9zTLb-EpuE-p6JMp-sd8cws2J0c9WOsm2ZYQoqovL7w"; 
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM
const loginDiv = document.getElementById('loginDiv');
const adminDiv = document.getElementById('adminDiv');
const emailInput = document.getElementById('email');
const passInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const addBtn = document.getElementById('addBtn');
const titleInput = document.getElementById('title');
const dateInput = document.getElementById('date');
const placeInput = document.getElementById('place');
const mapInput = document.getElementById('map_url');
const descInput = document.getElementById('description');
const eventListDiv = document.getElementById('eventList');
const imageInput = document.getElementById('imageFile');
const imageTitleInput = document.getElementById('imageTitle');
const uploadBtn = document.getElementById('uploadBtn');
const galleryAdminListDiv = document.getElementById('galleryAdminList');

let editingEventId = null;
let editingGalleryId = null;

// Firebase Auth
loginBtn.addEventListener('click', async ()=>{\n  try{\n    await signInWithEmailAndPassword(auth,emailInput.value,passInput.value);\n  }catch(e){ alert(e.message); }\n});

logoutBtn.addEventListener('click', ()=>signOut(auth));

// Auth state
onAuthStateChanged(auth,user=>{
  if(user){
    loginDiv.classList.add('hidden');
    adminDiv.classList.remove('hidden');
    loadAdminEvents();
    loadAdminGallery();
  } else {
    loginDiv.classList.remove('hidden');
    adminDiv.classList.add('hidden');
  }
});

// Add/Edit event with Firebase
addBtn.addEventListener('click', async ()=>{\n  const data = {\n    title: titleInput.value,\n    date: dateInput.value,\n    place: placeInput.value,\n    map_url: mapInput.value,\n    description: descInput.value\n  };\n  try {
    if(editingEventId){\n      await updateDoc(doc(db,'events',editingEventId), data);\n      editingEventId=null;\n      addBtn.textContent="Add Event";\n    } else {
      await addDoc(collection(db,'events'), data);\n    }\n    titleInput.value=""; dateInput.value=""; placeInput.value=""; mapInput.value=""; descInput.value="";
    loadAdminEvents();
  }catch(e){ alert(e.message); }\n});

// Load events in admin panel with Firebase
async function loadAdminEvents(){\n  eventListDiv.innerHTML="लोड होत आहे...";\n  try{\n    const snapshot = await getDocs(collection(db,'events'));
    const events = snapshot.docs.map(d=>({id:d.id,...d.data()}));
    eventListDiv.innerHTML="";
    events.forEach(ev=>{\n      const div = document.createElement('div');
      div.className='event-item';
      div.innerHTML=`
        <div>
          <strong>${ev.title}</strong> (${ev.date})
        </div>
        <div class="actions">
          <button onclick='editEvent("${ev.id}","${ev.title}","${ev.date}","${ev.place}","${ev.map_url}","${ev.description}")'>Edit</button>
          <button onclick='deleteEvent("${ev.id}")'>Delete</button>
        </div>
      `;
      eventListDiv.appendChild(div);\n    });
  }catch(e){ eventListDiv.innerHTML="लोड करता आले नाही."; console.error(e); }\n}

// Edit event function
window.editEvent = (id,title,date,place,map,desc)=>{\n  editingEventId=id;\n  titleInput.value=title;\n  dateInput.value=date;\n  placeInput.value=place;\n  mapInput.value=map;\n  descInput.value=desc;\n  addBtn.textContent="Update Event";\n};\n\n// Delete event with Firebase
window.deleteEvent = async (id) => {\n  if (confirm("Are you sure you want to delete this event?")) {\n    try {
      await deleteDoc(doc(db, 'events', id));
      loadAdminEvents();
    } catch (e) {\n      alert("Error deleting event: " + e.message);\n    }\n  }\n};\n\n// --- GALLERY FUNCTIONS (Supabase) ---
uploadBtn.addEventListener('click', async () => {
  const file = imageInput.files[0];
  const title = imageTitleInput.value;
  if (!file) {
    alert("Please select a file to upload.");
    return;
  }
  
  const user = auth.currentUser;
  if (!user) {
    alert("You must be logged in to upload images.");
    return;
  }
  
  const fileName = `${Date.now()}_${file.name}`;
  
  try {
    const { error: uploadError } = await supabase.storage.from('gallery-images').upload(fileName, file);
    if (uploadError) throw uploadError;
    
    const { data: { publicUrl } } = supabase.storage.from('gallery-images').getPublicUrl(fileName);
    
    const { error: insertError } = await supabase.from('gallery').insert([{ url: publicUrl, timestamp: Date.now(), title: title }]);
    if (insertError) throw insertError;

    alert("Image uploaded successfully!");
    imageInput.value = "";
    imageTitleInput.value = "";
    loadAdminGallery();
  } catch (e) {
    alert("Upload failed: " + e.message);
  }
});

// Load gallery for admin panel
async function loadAdminGallery() {
    galleryAdminListDiv.innerHTML = "लोड होत आहे...";
    try {
        const { data: images, error } = await supabase.from('gallery').select('*').order('timestamp', { ascending: false });
        if (error) throw error;
        
        galleryAdminListDiv.innerHTML = "";
        images.forEach(image => {
            const div = document.createElement("div");
            div.className = "gallery-item-admin";
            div.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <img src="${image.url}" alt="${image.title}">
                    <span>${image.title || 'No Title'}</span>
                </div>
                <div class="actions">
                    <button onclick='deleteGalleryImage("${image.id}", "${image.url}")'>Delete</button>
                </div>
            `;
            galleryAdminListDiv.appendChild(div);
        });
    } catch(e) {
        galleryAdminListDiv.innerHTML = 'गॅलरी लोड करता आली नाही.';
        console.error(e);
    }
}

// Delete gallery image with Supabase
window.deleteGalleryImage = async (id, imageUrl) => {
    if (confirm("Are you sure you want to delete this image?")) {
        try {
            // Extract the file name from the URL
            const fileName = imageUrl.substring(imageUrl.lastIndexOf('/') + 1);

            // Delete the file from Supabase Storage
            const { error: storageError } = await supabase.storage.from('gallery-images').remove([fileName]);
            if (storageError) throw storageError;

            // Delete the entry from the gallery table in the database
            const { error: dbError } = await supabase.from('gallery').delete().eq('id', id);
            if (dbError) throw dbError;

            loadAdminGallery();
        } catch (e) {
            alert("Error deleting image: " + e.message);
            console.error(e);
        }
    }
};

</script>
</head>
<body>
<header>Admin - दौरा कार्यक्रम</header>

<div class="container" id="loginDiv">
<h2>Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button id="loginBtn">Login</button>
</div>

<div class="container hidden" id="adminDiv">
<h2>Manage Events</h2>
<button id="logoutBtn">Logout</button>
<input type="text" id="title" placeholder="Title">
<input type="date" id="date">
<input type="text" id="place" placeholder="Place">
<input type="text" id="map_url" placeholder="Map URL (optional)">
<textarea id="description" placeholder="Description"></textarea>
<button id="addBtn">Add Event</button>

<div class="event-list" id="eventList"></div>

<div class="container" id="gallery-upload">
  <h2>Upload New Image</h2>
  <input type="text" id="imageTitle" placeholder="Image Title (optional)">
  <input type="file" id="imageFile" accept="image/*">
  <button id="uploadBtn">Upload Image</button>
</div>

<div class="container gallery-admin-list">
  <h2>Manage Gallery Images</h2>
  <div id="galleryAdminList"></div>
</div>

</div>
</body>
</html>
